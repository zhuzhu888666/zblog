<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>评论功能测试</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .test-section {
            margin-bottom: 40px;
            padding: 25px;
            border: 1px solid #e1e5e9;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .test-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .result-area {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
            max-height: 400px;
            overflow-y: auto;
        }

        .comment-item {
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .comment-user {
            font-weight: 600;
            color: #667eea;
        }

        .comment-time {
            color: #6c757d;
            font-size: 0.9em;
        }

        .comment-content {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .comment-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .like-btn {
            background: none;
            border: 1px solid #e1e5e9;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .like-btn.liked {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .reply-btn {
            background: none;
            border: 1px solid #667eea;
            color: #667eea;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .reply-btn:hover {
            background: #667eea;
            color: white;
        }

        .replies {
            margin-left: 20px;
            margin-top: 10px;
            padding-left: 15px;
            border-left: 2px solid #e1e5e9;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 15px;
            border: 1px solid #e1e5e9;
            background: white;
            cursor: pointer;
            border-radius: 5px;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        .nav-links {
            text-align: center;
            margin-top: 20px;
        }

        .nav-links a {
            color: #667eea;
            text-decoration: none;
            margin: 0 10px;
            padding: 8px 15px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .nav-links a:hover {
            background: #f8f9fa;
        }

        .quick-actions {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .quick-actions h3 {
            margin-bottom: 10px;
            color: #1976d2;
        }

        .quick-actions button {
            margin-right: 10px;
            margin-bottom: 5px;
        }

        .comment-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            display: none;
        }

        .comment-preview.show {
            display: block;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
            text-align: center;
            flex: 1;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
        }

        /* 评论区样式 */
        .comment-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
        }

        .comment-section-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .comment-count {
            color: #6c757d;
            font-size: 0.9em;
        }

        .quick-comment {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .quick-comment-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #e1e5e9;
        }

        .user-name {
            font-weight: 600;
            color: #333;
        }

        .quick-comment textarea {
            width: 100%;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 12px;
            resize: vertical;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.5;
        }

        .quick-comment textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .quick-comment-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .char-count {
            color: #6c757d;
            font-size: 0.9em;
        }

        .comments-list {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            min-height: 300px;
        }

        .loading-comments {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .comment-item {
            border-bottom: 1px solid #f0f0f0;
            padding: 20px;
            transition: background-color 0.3s ease;
        }

        .comment-item:last-child {
            border-bottom: none;
        }

        .comment-item:hover {
            background-color: #f8f9fa;
        }

        .comment-main {
            display: flex;
            gap: 12px;
        }

        .comment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #e1e5e9;
            flex-shrink: 0;
        }

        .comment-body {
            flex: 1;
        }

        .comment-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .comment-author {
            font-weight: 600;
            color: #333;
        }

        .comment-time {
            color: #6c757d;
            font-size: 0.85em;
        }

        .comment-content {
            color: #333;
            line-height: 1.6;
            margin-bottom: 12px;
            word-wrap: break-word;
        }

        .comment-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .comment-action {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #6c757d;
            font-size: 0.9em;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .comment-action:hover {
            color: #667eea;
        }

        .comment-action.liked {
            color: #dc3545;
        }

        .comment-action i {
            font-size: 16px;
        }

        .replies-section {
            margin-top: 15px;
            padding-left: 40px;
            border-left: 2px solid #f0f0f0;
        }

        .reply-item {
            border-bottom: 1px solid #f8f9fa;
            padding: 15px 0;
        }

        .reply-item:last-child {
            border-bottom: none;
        }

        .reply-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .reply-author {
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
        }

        .reply-target {
            color: #667eea;
            font-size: 0.9em;
        }

        .reply-content {
            color: #333;
            line-height: 1.5;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .reply-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .show-replies-btn {
            color: #667eea;
            font-size: 0.9em;
            cursor: pointer;
            margin-top: 10px;
            transition: color 0.3s ease;
        }

        .show-replies-btn:hover {
            color: #5a6fd8;
        }

        .comment-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
            padding: 20px;
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
        }

        .page-info {
            color: #6c757d;
            font-size: 0.9em;
        }

        .no-comments {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .no-comments i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .auto-refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
            z-index: 1000;
        }

        .auto-refresh-indicator.show {
            display: block;
        }

        /* 软删除说明样式 */
        .soft-delete-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .info-card {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 8px;
            padding: 20px;
        }

        .info-card h3 {
            color: #1976d2;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .info-card p {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .info-card ul {
            list-style: none;
            padding: 0;
        }

        .info-card li {
            margin-bottom: 8px;
            padding-left: 5px;
        }

        .status-legend {
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
        }

        .status-legend h4 {
            color: #333;
            margin-bottom: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-weight: bold;
            font-size: 0.9em;
            color: white;
        }

        .status-badge.normal {
            background: #28a745;
        }

        .status-badge.deleted {
            background: #dc3545;
        }

        .status-badge.pending {
            background: #ffc107;
            color: #212529;
        }

        .management-tools {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
        }

        .management-tools h4 {
            color: #856404;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .soft-delete-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>评论功能测试</h1>
            <p>测试评论系统的各项功能，包括添加、查看、回复、点赞等操作</p>
        </div>

        <div class="content">
            <!-- 基础设置 -->
            <div class="test-section">
                <h2>基础设置</h2>
                <div class="form-group">
                    <label for="songId">歌曲ID:</label>
                    <input type="number" id="songId" value="1" placeholder="请输入歌曲ID">
                </div>
                <div class="form-group">
                    <label for="userId">用户ID:</label>
                    <input type="number" id="userId" value="1" placeholder="请输入用户ID">
                </div>
                <div class="form-group">
                    <label for="currentUserId">当前用户ID:</label>
                    <input type="number" id="currentUserId" value="1" placeholder="当前登录用户ID">
                </div>
                <button class="btn" onclick="validateUsers()">验证用户</button>
                <div id="userValidationResult" class="result-area" style="display: none;"></div>
            </div>

            <!-- 快速操作 -->
            <div class="test-section">
                <h2>快速操作</h2>
                <div class="quick-actions">
                    <h3>常用测试场景</h3>
                    <button class="btn btn-success" onclick="loadTestData()">加载测试数据</button>
                    <button class="btn btn-secondary" onclick="clearAllResults()">清空所有结果</button>
                    <button class="btn btn-warning" onclick="testAllFunctions()">测试所有功能</button>
                </div>
            </div>

            <!-- 统计信息 -->
            <div class="test-section">
                <h2>统计信息</h2>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number" id="commentCount">-</div>
                        <div class="stat-label">评论总数</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="likeCount">-</div>
                        <div class="stat-label">点赞总数</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="userCount">-</div>
                        <div class="stat-label">活跃用户</div>
                    </div>
                </div>
                <button class="btn" onclick="refreshStats()">刷新统计</button>
            </div>

            <!-- 添加评论 -->
            <div class="test-section">
                <h2>添加评论</h2>
                <div class="form-group">
                    <label for="commentContent">评论内容:</label>
                    <textarea id="commentContent" placeholder="请输入评论内容" oninput="previewComment()"></textarea>
                </div>
                <div class="comment-preview" id="commentPreview">
                    <strong>预览:</strong>
                    <div id="previewContent"></div>
                </div>
                <button class="btn" onclick="addComment()" id="addCommentBtn">添加评论</button>
                <div id="addCommentResult" class="result-area" style="display: none;"></div>
            </div>

            <!-- 查看评论列表 -->
            <div class="test-section">
                <h2>查看评论列表</h2>
                <div class="form-group">
                    <label for="pageNum">页码:</label>
                    <input type="number" id="pageNum" value="1" min="1">
                </div>
                <div class="form-group">
                    <label for="pageSize">每页数量:</label>
                    <input type="number" id="pageSize" value="10" min="1" max="50">
                </div>
                <button class="btn" onclick="getComments()">获取评论列表</button>
                <button class="btn btn-secondary" onclick="getCommentCount()">获取评论总数</button>
                <div id="commentsResult" class="result-area" style="display: none;"></div>
            </div>

            <!-- 回复评论 -->
            <div class="test-section">
                <h2>回复评论</h2>
                <div class="form-group">
                    <label for="replyCommentId">要回复的评论ID:</label>
                    <input type="number" id="replyCommentId" placeholder="请输入评论ID">
                </div>
                <div class="form-group">
                    <label for="replyToUserId">回复目标用户ID:</label>
                    <input type="number" id="replyToUserId" placeholder="请输入用户ID">
                </div>
                <div class="form-group">
                    <label for="replyContent">回复内容:</label>
                    <textarea id="replyContent" placeholder="请输入回复内容"></textarea>
                </div>
                <button class="btn" onclick="replyComment()">回复评论</button>
                <div id="replyResult" class="result-area" style="display: none;"></div>
            </div>

            <!-- 点赞功能 -->
            <div class="test-section">
                <h2>点赞功能</h2>
                <div class="form-group">
                    <label for="likeCommentId">评论ID:</label>
                    <input type="number" id="likeCommentId" placeholder="请输入评论ID">
                </div>
                <button class="btn btn-success" onclick="likeComment()">点赞评论</button>
                <button class="btn btn-danger" onclick="unlikeComment()">取消点赞</button>
                <button class="btn btn-secondary" onclick="checkLikeStatus()">检查点赞状态</button>
                <button class="btn btn-warning" onclick="getLikeCount()">获取点赞数</button>
                <div id="likeResult" class="result-area" style="display: none;"></div>
            </div>

            <!-- 删除评论 -->
            <div class="test-section">
                <h2>删除评论</h2>
                <div class="form-group">
                    <label for="deleteCommentId">要删除的评论ID:</label>
                    <input type="number" id="deleteCommentId" placeholder="请输入评论ID">
                </div>
                <button class="btn btn-danger" onclick="deleteComment()">删除评论</button>
                <div id="deleteResult" class="result-area" style="display: none;"></div>
            </div>

            <!-- 获取评论详情 -->
            <div class="test-section">
                <h2>获取评论详情</h2>
                <div class="form-group">
                    <label for="detailCommentId">评论ID:</label>
                    <input type="number" id="detailCommentId" placeholder="请输入评论ID">
                </div>
                <button class="btn" onclick="getCommentDetail()">获取详情</button>
                <div id="detailResult" class="result-area" style="display: none;"></div>
            </div>

            <!-- 获取回复列表 -->
            <div class="test-section">
                <h2>获取回复列表</h2>
                <div class="form-group">
                    <label for="repliesCommentId">评论ID:</label>
                    <input type="number" id="repliesCommentId" placeholder="请输入评论ID">
                </div>
                <button class="btn" onclick="getReplies()">获取回复</button>
                <div id="repliesResult" class="result-area" style="display: none;"></div>
            </div>

            <!-- 用户评论列表 -->
            <div class="test-section">
                <h2>用户评论列表</h2>
                <div class="form-group">
                    <label for="userCommentsId">用户ID:</label>
                    <input type="number" id="userCommentsId" placeholder="请输入用户ID">
                </div>
                <button class="btn" onclick="getUserComments()">获取用户评论</button>
                <div id="userCommentsResult" class="result-area" style="display: none;"></div>
            </div>

            <!-- 软删除说明和管理 -->
            <div class="test-section">
                <h2>软删除机制说明</h2>
                <div class="soft-delete-info">
                    <div class="info-card">
                        <h3>💡 为什么删除后数据库还有记录？</h3>
                        <p>本系统采用<strong>软删除（逻辑删除）</strong>机制，这是一种安全的最佳实践：</p>
                        <ul>
                            <li>✅ 删除的评论不会在页面显示</li>
                            <li>✅ 数据库保留记录，防止误删除</li>
                            <li>✅ 支持数据恢复和审计追踪</li>
                            <li>✅ 保持数据完整性和关联关系</li>
                        </ul>
                    </div>
                    
                    <div class="status-legend">
                        <h4>评论状态说明：</h4>
                        <div class="status-item">
                            <span class="status-badge normal">1</span>
                            <span>正常评论（页面显示）</span>
                        </div>
                        <div class="status-item">
                            <span class="status-badge deleted">0</span>
                            <span>已删除评论（不显示）</span>
                        </div>
                        <div class="status-item">
                            <span class="status-badge pending">2</span>
                            <span>审核中评论（不显示）</span>
                        </div>
                    </div>
                </div>

                <div class="management-tools">
                    <h4>管理工具：</h4>
                    <button class="btn btn-secondary" onclick="showCommentStatistics()">查看评论统计</button>
                    <button class="btn btn-warning" onclick="showDeletedComments()">查看已删除评论</button>
                    <button class="btn" onclick="openSqlHelp()">SQL查询帮助</button>
                    <div id="managementResult" class="result-area" style="display: none;"></div>
                </div>
            </div>

            <!-- 实时评论区 -->
            <div class="test-section">
                <h2>实时评论区</h2>
                <div class="comment-section-header">
                    <div class="comment-section-info">
                        <span id="currentSongTitle">歌曲ID: <span id="displaySongId">1</span></span>
                        <span class="comment-count">共 <span id="displayCommentCount">0</span> 条评论</span>
                    </div>
                    <button class="btn btn-secondary" onclick="refreshComments()">刷新评论</button>
                    <button class="btn" onclick="toggleAutoRefresh()" id="autoRefreshBtn">开启自动刷新</button>
                </div>
                
                <!-- 快速发表评论 -->
                <div class="quick-comment">
                    <div class="quick-comment-header">
                        <img src="https://via.placeholder.com/40x40" alt="头像" class="user-avatar">
                        <span class="user-name">用户 <span id="quickUserId">1</span></span>
                    </div>
                    <textarea id="quickCommentContent" placeholder="写下你的评论..." rows="3"></textarea>
                    <div class="quick-comment-actions">
                        <button class="btn btn-success" onclick="quickAddComment()">发表评论</button>
                        <span class="char-count"><span id="charCount">0</span>/500</span>
                    </div>
                </div>

                <!-- 评论列表 -->
                <div id="commentsList" class="comments-list">
                    <div class="loading-comments">
                        <div class="loading">加载评论中...</div>
                    </div>
                </div>
                
                <!-- 分页控制 -->
                <div class="comment-pagination" id="commentPagination" style="display: none;">
                    <button class="btn btn-secondary" onclick="loadPreviousPage()" id="prevPageBtn">上一页</button>
                    <span class="page-info">第 <span id="currentPage">1</span> 页，共 <span id="totalPages">1</span> 页</span>
                    <button class="btn btn-secondary" onclick="loadNextPage()" id="nextPageBtn">下一页</button>
                </div>
            </div>
        </div>

        <div class="nav-links">
            <a href="/index.html">返回首页</a>
            <a href="/song-test.html">歌曲测试</a>
            <a href="/upload.html">文件上传</a>
        </div>
    </div>

    <!-- 自动刷新指示器 -->
    <div class="auto-refresh-indicator" id="autoRefreshIndicator">
        <span>🔄 自动刷新中...</span>
    </div>

    <script>
        // 显示结果
        function showResult(elementId, data, isSuccess = true) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            
            if (isSuccess) {
                element.innerHTML = `<div class="status success">请求成功</div><pre>${JSON.stringify(data, null, 2)}</pre>`;
            } else {
                element.innerHTML = `<div class="status error">请求失败</div><pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
        }

        // 显示加载状态
        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.innerHTML = '<div class="loading">加载中...</div>';
        }

        // 获取基础参数
        function getBaseParams() {
            return {
                songId: parseInt(document.getElementById('songId').value),
                userId: parseInt(document.getElementById('userId').value),
                currentUserId: parseInt(document.getElementById('currentUserId').value)
            };
        }

        // 验证用户
        async function validateUsers() {
            const params = getBaseParams();
            showLoading('userValidationResult');

            try {
                const promises = [
                    fetch(`/api/user/getUserAvatar?id=${params.userId}`),
                    fetch(`/api/user/getUserAvatar?id=${params.currentUserId}`)
                ];

                const results = await Promise.all(promises);
                const userData = await results[0].json();
                const currentUserData = await results[1].json();

                const validationResult = {
                    userId: params.userId,
                    currentUserId: params.currentUserId,
                    userValid: userData.code === 1,
                    currentUserValid: currentUserData.code === 1,
                    userInfo: userData.data,
                    currentUserInfo: currentUserData.data
                };

                showResult('userValidationResult', validationResult, true);
            } catch (error) {
                showResult('userValidationResult', { error: error.message }, false);
            }
        }

        // 加载测试数据
        function loadTestData() {
            document.getElementById('songId').value = '1';
            document.getElementById('userId').value = '1';
            document.getElementById('currentUserId').value = '1';
            document.getElementById('commentContent').value = '这是一条测试评论！';
            document.getElementById('replyContent').value = '这是一条测试回复！';
            alert('测试数据已加载，请开始测试！');
        }

        // 清空所有结果
        function clearAllResults() {
            const resultAreas = document.querySelectorAll('.result-area');
            resultAreas.forEach(area => {
                area.style.display = 'none';
                area.innerHTML = '';
            });
        }

        // 测试所有功能
        async function testAllFunctions() {
            clearAllResults();
            
            // 设置测试数据
            loadTestData();
            
            // 依次测试各个功能
            await addComment();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await getComments();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await getCommentCount();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await refreshStats();
            
            alert('所有功能测试完成！请查看各个结果区域。');
        }

        // 刷新统计信息
        async function refreshStats() {
            const params = getBaseParams();
            
            try {
                const [commentCountRes, likeCountRes] = await Promise.all([
                    fetch(`/api/comment/count?songId=${params.songId}`),
                    fetch(`/api/comment/like/count?commentId=1`)
                ]);
                
                const commentCountData = await commentCountRes.json();
                const likeCountData = await likeCountRes.json();
                
                document.getElementById('commentCount').textContent = commentCountData.data || 0;
                document.getElementById('likeCount').textContent = likeCountData.data || 0;
                document.getElementById('userCount').textContent = '3'; // 测试用户数
            } catch (error) {
                console.error('刷新统计失败:', error);
            }
        }

        // 预览评论
        function previewComment() {
            const content = document.getElementById('commentContent').value;
            const preview = document.getElementById('commentPreview');
            const previewContent = document.getElementById('previewContent');
            
            if (content.trim()) {
                previewContent.textContent = content;
                preview.classList.add('show');
            } else {
                preview.classList.remove('show');
            }
        }

        // 添加评论
        async function addComment() {
            const content = document.getElementById('commentContent').value;
            if (!content.trim()) {
                alert('请输入评论内容');
                return;
            }

            const params = getBaseParams();
            const data = {
                songId: params.songId,
                userId: params.userId,
                content: content
            };

            const btn = document.getElementById('addCommentBtn');
            btn.disabled = true;
            btn.textContent = '添加中...';

            showLoading('addCommentResult');

            try {
                const response = await fetch('/api/comment/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                showResult('addCommentResult', result, result.code === 1);
                
                if (result.code === 1) {
                    // 清空输入框
                    document.getElementById('commentContent').value = '';
                    document.getElementById('commentPreview').classList.remove('show');
                    // 刷新统计
                    refreshStats();
                }
            } catch (error) {
                showResult('addCommentResult', { error: error.message }, false);
            } finally {
                btn.disabled = false;
                btn.textContent = '添加评论';
            }
        }

        // 获取评论列表
        async function getComments() {
            const params = getBaseParams();
            const pageNum = document.getElementById('pageNum').value;
            const pageSize = document.getElementById('pageSize').value;

            showLoading('commentsResult');

            try {
                const url = `/api/comment/song/page?songId=${params.songId}&currentUserId=${params.currentUserId}&pageNum=${pageNum}&pageSize=${pageSize}`;
                const response = await fetch(url);
                const result = await response.json();
                showResult('commentsResult', result, result.code === 1);
            } catch (error) {
                showResult('commentsResult', { error: error.message }, false);
            }
        }

        // 获取评论总数
        async function getCommentCount() {
            const params = getBaseParams();

            showLoading('commentsResult');

            try {
                const url = `/api/comment/count?songId=${params.songId}`;
                const response = await fetch(url);
                const result = await response.json();
                showResult('commentsResult', result, result.code === 1);
            } catch (error) {
                showResult('commentsResult', { error: error.message }, false);
            }
        }

        // 回复评论
        async function replyComment() {
            const commentId = document.getElementById('replyCommentId').value;
            const replyToUserId = document.getElementById('replyToUserId').value;
            const content = document.getElementById('replyContent').value;

            if (!commentId || !content.trim()) {
                alert('请输入评论ID和回复内容');
                return;
            }

            const params = getBaseParams();
            const data = {
                commentId: parseInt(commentId),
                userId: params.userId,
                replyToUserId: parseInt(replyToUserId),
                content: content
            };

            showLoading('replyResult');

            try {
                const response = await fetch('/api/comment/reply', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                showResult('replyResult', result, result.code === 1);
                
                if (result.code === 1) {
                    // 清空输入框
                    document.getElementById('replyContent').value = '';
                }
            } catch (error) {
                showResult('replyResult', { error: error.message }, false);
            }
        }

        // 点赞评论
        async function likeComment() {
            const commentId = document.getElementById('likeCommentId').value;
            if (!commentId) {
                alert('请输入评论ID');
                return;
            }

            const params = getBaseParams();
            const data = {
                commentId: parseInt(commentId),
                userId: params.userId
            };

            showLoading('likeResult');

            try {
                const response = await fetch('/api/comment/like', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                showResult('likeResult', result, result.code === 1);
            } catch (error) {
                showResult('likeResult', { error: error.message }, false);
            }
        }

        // 取消点赞
        async function unlikeComment() {
            const commentId = document.getElementById('likeCommentId').value;
            if (!commentId) {
                alert('请输入评论ID');
                return;
            }

            const params = getBaseParams();
            const data = {
                commentId: parseInt(commentId),
                userId: params.userId
            };

            showLoading('likeResult');

            try {
                const response = await fetch('/api/comment/unlike', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                showResult('likeResult', result, result.code === 1);
            } catch (error) {
                showResult('likeResult', { error: error.message }, false);
            }
        }

        // 检查点赞状态
        async function checkLikeStatus() {
            const commentId = document.getElementById('likeCommentId').value;
            if (!commentId) {
                alert('请输入评论ID');
                return;
            }

            const params = getBaseParams();

            showLoading('likeResult');

            try {
                const url = `/api/comment/like/check?commentId=${commentId}&userId=${params.userId}`;
                const response = await fetch(url);
                const result = await response.json();
                showResult('likeResult', result, result.code === 1);
            } catch (error) {
                showResult('likeResult', { error: error.message }, false);
            }
        }

        // 获取点赞数
        async function getLikeCount() {
            const commentId = document.getElementById('likeCommentId').value;
            if (!commentId) {
                alert('请输入评论ID');
                return;
            }

            showLoading('likeResult');

            try {
                const url = `/api/comment/like/count?commentId=${commentId}`;
                const response = await fetch(url);
                const result = await response.json();
                showResult('likeResult', result, result.code === 1);
            } catch (error) {
                showResult('likeResult', { error: error.message }, false);
            }
        }

        // 删除评论
        async function deleteComment() {
            const commentId = document.getElementById('deleteCommentId').value;
            if (!commentId) {
                alert('请输入评论ID');
                return;
            }

            if (!confirm('确定要删除这条评论吗？此操作不可恢复。')) {
                return;
            }

            const params = getBaseParams();

            showLoading('deleteResult');

            try {
                const response = await fetch('/api/comment/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `commentId=${commentId}&userId=${params.userId}`
                });

                const result = await response.json();
                showResult('deleteResult', result, result.code === 1);
            } catch (error) {
                showResult('deleteResult', { error: error.message }, false);
            }
        }

        // 获取评论详情
        async function getCommentDetail() {
            const commentId = document.getElementById('detailCommentId').value;
            if (!commentId) {
                alert('请输入评论ID');
                return;
            }

            const params = getBaseParams();

            showLoading('detailResult');

            try {
                const url = `/api/comment/detail?commentId=${commentId}&currentUserId=${params.currentUserId}`;
                const response = await fetch(url);
                const result = await response.json();
                showResult('detailResult', result, result.code === 1);
            } catch (error) {
                showResult('detailResult', { error: error.message }, false);
            }
        }

        // 获取回复列表
        async function getReplies() {
            const commentId = document.getElementById('repliesCommentId').value;
            if (!commentId) {
                alert('请输入评论ID');
                return;
            }

            const params = getBaseParams();

            showLoading('repliesResult');

            try {
                const url = `/api/comment/replies?commentId=${commentId}&currentUserId=${params.currentUserId}`;
                const response = await fetch(url);
                const result = await response.json();
                showResult('repliesResult', result, result.code === 1);
            } catch (error) {
                showResult('repliesResult', { error: error.message }, false);
            }
        }

        // 获取用户评论列表
        async function getUserComments() {
            const userId = document.getElementById('userCommentsId').value;
            if (!userId) {
                alert('请输入用户ID');
                return;
            }

            const params = getBaseParams();

            showLoading('userCommentsResult');

            try {
                const url = `/api/comment/user?userId=${userId}&currentUserId=${params.currentUserId}`;
                const response = await fetch(url);
                const result = await response.json();
                showResult('userCommentsResult', result, result.code === 1);
            } catch (error) {
                showResult('userCommentsResult', { error: error.message }, false);
            }
        }

        // 评论区相关变量
        let currentCommentPage = 1;
        let commentPageSize = 10;
        let totalCommentPages = 1;
        let autoRefreshInterval = null;
        let isAutoRefresh = false;

        // 初始化评论区
        function initializeCommentsSection() {
            updateDisplayValues();
            loadCommentsPage(1);
            
            // 绑定快速评论输入框事件
            const quickCommentInput = document.getElementById('quickCommentContent');
            quickCommentInput.addEventListener('input', function() {
                const charCount = this.value.length;
                document.getElementById('charCount').textContent = charCount;
                
                if (charCount > 500) {
                    this.value = this.value.substring(0, 500);
                    document.getElementById('charCount').textContent = 500;
                }
            });
        }

        // 更新显示的值
        function updateDisplayValues() {
            const params = getBaseParams();
            document.getElementById('displaySongId').textContent = params.songId;
            document.getElementById('quickUserId').textContent = params.userId;
        }

        // 快速发表评论
        async function quickAddComment() {
            const content = document.getElementById('quickCommentContent').value.trim();
            if (!content) {
                alert('请输入评论内容');
                return;
            }

            const params = getBaseParams();
            const data = {
                songId: params.songId,
                userId: params.userId,
                content: content
            };

            try {
                const response = await fetch('/api/comment/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.code === 1) {
                    document.getElementById('quickCommentContent').value = '';
                    document.getElementById('charCount').textContent = '0';
                    
                    // 刷新评论列表
                    await loadCommentsPage(1);
                    await refreshStats();
                    
                    // 显示成功提示
                    showToast('评论发表成功！', 'success');
                } else {
                    showToast('发表失败：' + result.message, 'error');
                }
            } catch (error) {
                console.error('发表评论失败:', error);
                showToast('网络错误，请重试', 'error');
            }
        }

        // 加载评论页面
        async function loadCommentsPage(page) {
            currentCommentPage = page;
            const params = getBaseParams();
            
            try {
                showCommentsLoading();
                
                const response = await fetch(`/api/comment/song/page?songId=${params.songId}&currentUserId=${params.currentUserId}&pageNum=${page}&pageSize=${commentPageSize}`);
                const result = await response.json();
                
                if (result.code === 1) {
                    displayComments(result.data);
                    updateCommentPagination(result.data);
                    updateCommentCount(result.data.total);
                } else {
                    showCommentsError('加载评论失败：' + result.message);
                }
            } catch (error) {
                console.error('加载评论失败:', error);
                showCommentsError('网络错误，请重试');
            }
        }

        // 显示评论列表
        function displayComments(pageData) {
            const commentsList = document.getElementById('commentsList');
            
            if (!pageData.data || pageData.data.length === 0) {
                commentsList.innerHTML = `
                    <div class="no-comments">
                        <div style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;">💬</div>
                        <div>暂无评论，快来发表第一条评论吧！</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            pageData.data.forEach(comment => {
                html += generateCommentHTML(comment);
            });
            
            commentsList.innerHTML = html;
        }

        // 生成评论HTML
        function generateCommentHTML(comment) {
            const timeAgo = formatTimeAgo(comment.createTime);
            const avatarUrl = comment.userAvatar || 'https://via.placeholder.com/40x40';
            
            let repliesHTML = '';
            if (comment.replyCount > 0) {
                repliesHTML = `
                    <div class="show-replies-btn" onclick="toggleReplies(${comment.id})">
                        <span id="repliesText_${comment.id}">查看 ${comment.replyCount} 条回复</span>
                    </div>
                    <div id="replies_${comment.id}" class="replies-section" style="display: none;">
                        <div class="loading">加载回复中...</div>
                    </div>
                `;
            }
            
            return `
                <div class="comment-item" data-comment-id="${comment.id}">
                    <div class="comment-main">
                        <img src="${avatarUrl}" alt="头像" class="comment-avatar">
                        <div class="comment-body">
                            <div class="comment-meta">
                                <span class="comment-author">${comment.userNickname || '用户' + comment.userId}</span>
                                <span class="comment-time">${timeAgo}</span>
                            </div>
                            <div class="comment-content">${escapeHtml(comment.content)}</div>
                            <div class="comment-actions">
                                <div class="comment-action ${comment.isLiked ? 'liked' : ''}" onclick="toggleLike(${comment.id}, ${comment.userId})">
                                    <span>${comment.isLiked ? '❤️' : '🤍'}</span>
                                    <span id="likeCount_${comment.id}">${comment.likeCount}</span>
                                </div>
                                <div class="comment-action" onclick="showReplyForm(${comment.id}, '${comment.userNickname || '用户' + comment.userId}')">
                                    <span>💬</span>
                                    <span>回复</span>
                                </div>
                                ${comment.userId === getBaseParams().currentUserId ? `
                                    <div class="comment-action" onclick="deleteCommentConfirm(${comment.id})">
                                        <span>🗑️</span>
                                        <span>删除</span>
                                    </div>
                                ` : ''}
                            </div>
                            ${repliesHTML}
                        </div>
                    </div>
                </div>
            `;
        }

        // 生成回复HTML
        function generateReplyHTML(reply) {
            const timeAgo = formatTimeAgo(reply.createTime);
            const replyTarget = reply.replyToUserNickname ? `回复 @${reply.replyToUserNickname}` : '';
            
            return `
                <div class="reply-item" data-reply-id="${reply.id}">
                    <div class="reply-meta">
                        <span class="reply-author">${reply.userNickname || '用户' + reply.userId}</span>
                        ${replyTarget ? `<span class="reply-target">${replyTarget}</span>` : ''}
                        <span class="comment-time">${timeAgo}</span>
                    </div>
                    <div class="reply-content">${escapeHtml(reply.content)}</div>
                    <div class="reply-actions">
                        <div class="comment-action ${reply.isLiked ? 'liked' : ''}" onclick="toggleLike(${reply.id}, ${reply.userId})">
                            <span>${reply.isLiked ? '❤️' : '🤍'}</span>
                            <span id="likeCount_${reply.id}">${reply.likeCount}</span>
                        </div>
                        <div class="comment-action" onclick="showReplyForm(${reply.id}, '${reply.userNickname || '用户' + reply.userId}')">
                            <span>💬</span>
                            <span>回复</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // 切换回复显示
        async function toggleReplies(commentId) {
            const repliesDiv = document.getElementById(`replies_${commentId}`);
            const repliesText = document.getElementById(`repliesText_${commentId}`);
            
            if (repliesDiv.style.display === 'none') {
                // 显示回复
                repliesDiv.style.display = 'block';
                repliesText.textContent = '收起回复';
                
                // 加载回复
                try {
                    const params = getBaseParams();
                    const response = await fetch(`/api/comment/replies?commentId=${commentId}&currentUserId=${params.currentUserId}`);
                    const result = await response.json();
                    
                    if (result.code === 1 && result.data) {
                        let repliesHTML = '';
                        result.data.forEach(reply => {
                            repliesHTML += generateReplyHTML(reply);
                        });
                        repliesDiv.innerHTML = repliesHTML;
                    } else {
                        repliesDiv.innerHTML = '<div class="no-comments">暂无回复</div>';
                    }
                } catch (error) {
                    console.error('加载回复失败:', error);
                    repliesDiv.innerHTML = '<div class="no-comments">加载回复失败</div>';
                }
            } else {
                // 隐藏回复
                repliesDiv.style.display = 'none';
                repliesText.textContent = `查看回复`;
            }
        }

        // 切换点赞
        async function toggleLike(commentId, authorUserId) {
            const params = getBaseParams();
            const likeCountSpan = document.getElementById(`likeCount_${commentId}`);
            const currentCount = parseInt(likeCountSpan.textContent);
            
            try {
                // 先检查点赞状态
                const checkResponse = await fetch(`/api/comment/like/check?commentId=${commentId}&userId=${params.userId}`);
                const checkResult = await checkResponse.json();
                
                if (checkResult.code === 1) {
                    const isLiked = checkResult.data;
                    const url = isLiked ? '/api/comment/unlike' : '/api/comment/like';
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            commentId: commentId,
                            userId: params.userId
                        })
                    });
                    
                    const result = await response.json();
                    if (result.code === 1) {
                        // 更新UI
                        const actionElement = likeCountSpan.parentElement;
                        if (isLiked) {
                            actionElement.classList.remove('liked');
                            actionElement.querySelector('span:first-child').textContent = '🤍';
                            likeCountSpan.textContent = Math.max(0, currentCount - 1);
                        } else {
                            actionElement.classList.add('liked');
                            actionElement.querySelector('span:first-child').textContent = '❤️';
                            likeCountSpan.textContent = currentCount + 1;
                        }
                    }
                }
            } catch (error) {
                console.error('点赞操作失败:', error);
                showToast('操作失败，请重试', 'error');
            }
        }

        // 显示回复表单
        function showReplyForm(commentId, authorName) {
            const replyContent = prompt(`回复 @${authorName}:`);
            if (replyContent && replyContent.trim()) {
                submitReply(commentId, replyContent.trim());
            }
        }

        // 提交回复
        async function submitReply(commentId, content) {
            const params = getBaseParams();
            
            try {
                const response = await fetch('/api/comment/reply', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        commentId: commentId,
                        userId: params.userId,
                        replyToUserId: 0, // 暂时设为0，可以根据需要修改
                        content: content
                    })
                });
                
                const result = await response.json();
                if (result.code === 1) {
                    showToast('回复成功！', 'success');
                    // 重新加载当前页面
                    await loadCommentsPage(currentCommentPage);
                } else {
                    showToast('回复失败：' + result.message, 'error');
                }
            } catch (error) {
                console.error('提交回复失败:', error);
                showToast('网络错误，请重试', 'error');
            }
        }

        // 删除评论确认
        function deleteCommentConfirm(commentId) {
            if (confirm('确定要删除这条评论吗？此操作不可恢复。')) {
                deleteCommentById(commentId);
            }
        }

        // 删除评论
        async function deleteCommentById(commentId) {
            const params = getBaseParams();
            
            try {
                const response = await fetch('/api/comment/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `commentId=${commentId}&userId=${params.userId}`
                });
                
                const result = await response.json();
                if (result.code === 1) {
                    showToast('删除成功！', 'success');
                    // 重新加载当前页面
                    await loadCommentsPage(currentCommentPage);
                    await refreshStats();
                } else {
                    showToast('删除失败：' + result.message, 'error');
                }
            } catch (error) {
                console.error('删除评论失败:', error);
                showToast('网络错误，请重试', 'error');
            }
        }

        // 刷新评论
        async function refreshComments() {
            updateDisplayValues();
            await loadCommentsPage(currentCommentPage);
            await refreshStats();
            showToast('评论已刷新', 'info');
        }

        // 切换自动刷新
        function toggleAutoRefresh() {
            const btn = document.getElementById('autoRefreshBtn');
            const indicator = document.getElementById('autoRefreshIndicator');
            
            if (isAutoRefresh) {
                // 关闭自动刷新
                clearInterval(autoRefreshInterval);
                isAutoRefresh = false;
                btn.textContent = '开启自动刷新';
                btn.classList.remove('btn-danger');
                indicator.classList.remove('show');
            } else {
                // 开启自动刷新
                autoRefreshInterval = setInterval(async () => {
                    await loadCommentsPage(currentCommentPage);
                    await refreshStats();
                }, 10000); // 每10秒刷新一次
                
                isAutoRefresh = true;
                btn.textContent = '关闭自动刷新';
                btn.classList.add('btn-danger');
                indicator.classList.add('show');
                showToast('已开启自动刷新（每10秒）', 'success');
            }
        }

        // 上一页
        function loadPreviousPage() {
            if (currentCommentPage > 1) {
                loadCommentsPage(currentCommentPage - 1);
            }
        }

        // 下一页
        function loadNextPage() {
            if (currentCommentPage < totalCommentPages) {
                loadCommentsPage(currentCommentPage + 1);
            }
        }

        // 更新分页信息
        function updateCommentPagination(pageData) {
            const pagination = document.getElementById('commentPagination');
            const currentPageSpan = document.getElementById('currentPage');
            const totalPagesSpan = document.getElementById('totalPages');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            
            totalCommentPages = pageData.totalPages || 1;
            
            currentPageSpan.textContent = currentCommentPage;
            totalPagesSpan.textContent = totalCommentPages;
            
            prevBtn.disabled = currentCommentPage <= 1;
            nextBtn.disabled = currentCommentPage >= totalCommentPages;
            
            pagination.style.display = totalCommentPages > 1 ? 'flex' : 'none';
        }

        // 更新评论数量
        function updateCommentCount(total) {
            document.getElementById('displayCommentCount').textContent = total || 0;
        }

        // 显示评论加载状态
        function showCommentsLoading() {
            document.getElementById('commentsList').innerHTML = `
                <div class="loading-comments">
                    <div class="loading">加载评论中...</div>
                </div>
            `;
        }

        // 显示评论错误
        function showCommentsError(message) {
            document.getElementById('commentsList').innerHTML = `
                <div class="no-comments">
                    <div style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;">⚠️</div>
                    <div>${message}</div>
                </div>
            `;
        }

        // 格式化时间
        function formatTimeAgo(dateString) {
            if (!dateString) return '刚刚';
            
            const date = new Date(dateString);
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return '刚刚';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}分钟前`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}小时前`;
            if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)}天前`;
            
            return date.toLocaleDateString();
        }

        // HTML转义
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 显示提示消息
        function showToast(message, type = 'info') {
            // 创建提示元素
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
                color: white;
                padding: 12px 20px;
                border-radius: 5px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                z-index: 1001;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // 显示动画
            setTimeout(() => toast.style.opacity = '1', 100);
            
            // 自动消失
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // 软删除管理功能
        function showCommentStatistics() {
            const statisticsData = {
                title: "评论统计信息",
                description: "以下SQL可以帮助您了解评论的状态分布",
                queries: [
                    {
                        name: "评论状态统计",
                        sql: `SELECT 
    status,
    CASE 
        WHEN status = 0 THEN '已删除'
        WHEN status = 1 THEN '正常'
        WHEN status = 2 THEN '审核中'
        ELSE '未知'
    END as status_name,
    COUNT(*) as count
FROM tb_comment 
GROUP BY status;`
                    },
                    {
                        name: "删除率统计",
                        sql: `SELECT 
    COUNT(CASE WHEN status = 1 THEN 1 END) as active_comments,
    COUNT(CASE WHEN status = 0 THEN 1 END) as deleted_comments,
    ROUND(COUNT(CASE WHEN status = 0 THEN 1 END) * 100.0 / COUNT(*), 2) as deletion_rate
FROM tb_comment;`
                    }
                ]
            };
            
            showResult('managementResult', statisticsData, true);
        }

        function showDeletedComments() {
            const deletedCommentsData = {
                title: "查看已删除评论",
                description: "使用以下SQL查询已删除的评论记录",
                queries: [
                    {
                        name: "查看所有已删除评论",
                        sql: `SELECT 
    c.id, 
    c.user_id, 
    u.nickname as user_nickname,
    c.content, 
    c.create_time, 
    c.update_time as delete_time
FROM tb_comment c
LEFT JOIN tb_user u ON c.user_id = u.id
WHERE c.status = 0 
ORDER BY c.update_time DESC;`
                    },
                    {
                        name: "查看特定歌曲的已删除评论",
                        sql: `SELECT 
    c.id, 
    c.user_id, 
    u.nickname as user_nickname,
    c.content, 
    c.create_time, 
    c.update_time as delete_time
FROM tb_comment c
LEFT JOIN tb_user u ON c.user_id = u.id
WHERE c.status = 0 AND c.song_id = 1
ORDER BY c.update_time DESC;`
                    },
                    {
                        name: "恢复特定评论（谨慎使用）",
                        sql: `-- 恢复ID为1的评论
UPDATE tb_comment 
SET status = 1, update_time = NOW() 
WHERE id = 1 AND status = 0;`
                    }
                ]
            };
            
            showResult('managementResult', deletedCommentsData, true);
        }

        function openSqlHelp() {
            const sqlHelpData = {
                title: "SQL查询帮助",
                description: "常用的评论管理SQL语句",
                queries: [
                    {
                        name: "查看所有评论（包括已删除）",
                        sql: `SELECT 
    id, user_id, content, status, 
    create_time, update_time 
FROM tb_comment 
ORDER BY create_time DESC;`
                    },
                    {
                        name: "查看正常评论（页面显示的）",
                        sql: `SELECT 
    id, user_id, content, status, 
    create_time, update_time 
FROM tb_comment 
WHERE status = 1 
ORDER BY create_time DESC;`
                    },
                    {
                        name: "物理删除已标记删除的评论（危险操作）",
                        sql: `-- 删除超过30天的已删除评论
DELETE FROM tb_comment 
WHERE status = 0 
AND update_time < DATE_SUB(NOW(), INTERVAL 30 DAY);`
                    },
                    {
                        name: "批量恢复某用户的评论",
                        sql: `-- 恢复用户ID为1的所有已删除评论
UPDATE tb_comment 
SET status = 1, update_time = NOW() 
WHERE user_id = 1 AND status = 0;`
                    },
                    {
                        name: "查看评论与用户信息关联",
                        sql: `SELECT 
    c.id, 
    c.content, 
    c.status,
    u.nickname as user_name,
    c.create_time,
    CASE 
        WHEN c.status = 0 THEN '已删除'
        WHEN c.status = 1 THEN '正常'
        WHEN c.status = 2 THEN '审核中'
    END as status_text
FROM tb_comment c
LEFT JOIN tb_user u ON c.user_id = u.id
ORDER BY c.create_time DESC;`
                    }
                ],
                tips: [
                    "💡 建议先在测试环境运行这些SQL",
                    "⚠️ 物理删除操作不可恢复，请谨慎使用",
                    "🔍 使用WHERE条件限制操作范围",
                    "📊 定期检查删除率，了解用户行为"
                ]
            };
            
            showResult('managementResult', sqlHelpData, true);
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            refreshStats();
            initializeCommentsSection();
        });
    </script>
</body>
</html> 