<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯„è®ºåŠŸèƒ½æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .test-section {
            margin-bottom: 40px;
            padding: 25px;
            border: 1px solid #e1e5e9;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .test-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .result-area {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
            max-height: 400px;
            overflow-y: auto;
        }

        .comment-item {
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .comment-user {
            font-weight: 600;
            color: #667eea;
        }

        .comment-time {
            color: #6c757d;
            font-size: 0.9em;
        }

        .comment-content {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .comment-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .like-btn {
            background: none;
            border: 1px solid #e1e5e9;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .like-btn.liked {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .reply-btn {
            background: none;
            border: 1px solid #667eea;
            color: #667eea;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .reply-btn:hover {
            background: #667eea;
            color: white;
        }

        .replies {
            margin-left: 20px;
            margin-top: 10px;
            padding-left: 15px;
            border-left: 2px solid #e1e5e9;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 15px;
            border: 1px solid #e1e5e9;
            background: white;
            cursor: pointer;
            border-radius: 5px;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        .nav-links {
            text-align: center;
            margin-top: 20px;
        }

        .nav-links a {
            color: #667eea;
            text-decoration: none;
            margin: 0 10px;
            padding: 8px 15px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .nav-links a:hover {
            background: #f8f9fa;
        }

        .quick-actions {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .quick-actions h3 {
            margin-bottom: 10px;
            color: #1976d2;
        }

        .quick-actions button {
            margin-right: 10px;
            margin-bottom: 5px;
        }

        .comment-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            display: none;
        }

        .comment-preview.show {
            display: block;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
            text-align: center;
            flex: 1;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
        }

        /* è¯„è®ºåŒºæ ·å¼ */
        .comment-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
        }

        .comment-section-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .comment-count {
            color: #6c757d;
            font-size: 0.9em;
        }

        .quick-comment {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .quick-comment-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #e1e5e9;
        }

        .user-name {
            font-weight: 600;
            color: #333;
        }

        .quick-comment textarea {
            width: 100%;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 12px;
            resize: vertical;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.5;
        }

        .quick-comment textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .quick-comment-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .char-count {
            color: #6c757d;
            font-size: 0.9em;
        }

        .comments-list {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            min-height: 300px;
        }

        .loading-comments {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .comment-item {
            border-bottom: 1px solid #f0f0f0;
            padding: 20px;
            transition: background-color 0.3s ease;
        }

        .comment-item:last-child {
            border-bottom: none;
        }

        .comment-item:hover {
            background-color: #f8f9fa;
        }

        .comment-main {
            display: flex;
            gap: 12px;
        }

        .comment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #e1e5e9;
            flex-shrink: 0;
        }

        .comment-body {
            flex: 1;
        }

        .comment-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .comment-author {
            font-weight: 600;
            color: #333;
        }

        .comment-time {
            color: #6c757d;
            font-size: 0.85em;
        }

        .comment-content {
            color: #333;
            line-height: 1.6;
            margin-bottom: 12px;
            word-wrap: break-word;
        }

        .comment-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .comment-action {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #6c757d;
            font-size: 0.9em;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .comment-action:hover {
            color: #667eea;
        }

        .comment-action.liked {
            color: #dc3545;
        }

        .comment-action i {
            font-size: 16px;
        }

        .replies-section {
            margin-top: 15px;
            padding-left: 40px;
            border-left: 2px solid #f0f0f0;
        }

        .reply-item {
            border-bottom: 1px solid #f8f9fa;
            padding: 15px 0;
        }

        .reply-item:last-child {
            border-bottom: none;
        }

        .reply-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .reply-author {
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
        }

        .reply-target {
            color: #667eea;
            font-size: 0.9em;
        }

        .reply-content {
            color: #333;
            line-height: 1.5;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .reply-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .show-replies-btn {
            color: #667eea;
            font-size: 0.9em;
            cursor: pointer;
            margin-top: 10px;
            transition: color 0.3s ease;
        }

        .show-replies-btn:hover {
            color: #5a6fd8;
        }

        .comment-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
            padding: 20px;
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
        }

        .page-info {
            color: #6c757d;
            font-size: 0.9em;
        }

        .no-comments {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .no-comments i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .auto-refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
            z-index: 1000;
        }

        .auto-refresh-indicator.show {
            display: block;
        }

        /* è½¯åˆ é™¤è¯´æ˜æ ·å¼ */
        .soft-delete-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .info-card {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 8px;
            padding: 20px;
        }

        .info-card h3 {
            color: #1976d2;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .info-card p {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .info-card ul {
            list-style: none;
            padding: 0;
        }

        .info-card li {
            margin-bottom: 8px;
            padding-left: 5px;
        }

        .status-legend {
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
        }

        .status-legend h4 {
            color: #333;
            margin-bottom: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-weight: bold;
            font-size: 0.9em;
            color: white;
        }

        .status-badge.normal {
            background: #28a745;
        }

        .status-badge.deleted {
            background: #dc3545;
        }

        .status-badge.pending {
            background: #ffc107;
            color: #212529;
        }

        .management-tools {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
        }

        .management-tools h4 {
            color: #856404;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .soft-delete-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>è¯„è®ºåŠŸèƒ½æµ‹è¯•</h1>
            <p>æµ‹è¯•è¯„è®ºç³»ç»Ÿçš„å„é¡¹åŠŸèƒ½ï¼ŒåŒ…æ‹¬æ·»åŠ ã€æŸ¥çœ‹ã€å›å¤ã€ç‚¹èµç­‰æ“ä½œ</p>
        </div>

        <div class="content">
            <!-- åŸºç¡€è®¾ç½® -->
            <div class="test-section">
                <h2>åŸºç¡€è®¾ç½®</h2>
                <div class="form-group">
                    <label for="songId">æ­Œæ›²ID:</label>
                    <input type="number" id="songId" value="1" placeholder="è¯·è¾“å…¥æ­Œæ›²ID">
                </div>
                <div class="form-group">
                    <label for="userId">ç”¨æˆ·ID:</label>
                    <input type="number" id="userId" value="1" placeholder="è¯·è¾“å…¥ç”¨æˆ·ID">
                </div>
                <div class="form-group">
                    <label for="currentUserId">å½“å‰ç”¨æˆ·ID:</label>
                    <input type="number" id="currentUserId" value="1" placeholder="å½“å‰ç™»å½•ç”¨æˆ·ID">
                </div>
                <button class="btn" onclick="validateUsers()">éªŒè¯ç”¨æˆ·</button>
                <div id="userValidationResult" class="result-area" style="display: none;"></div>
            </div>

            <!-- å¿«é€Ÿæ“ä½œ -->
            <div class="test-section">
                <h2>å¿«é€Ÿæ“ä½œ</h2>
                <div class="quick-actions">
                    <h3>å¸¸ç”¨æµ‹è¯•åœºæ™¯</h3>
                    <button class="btn btn-success" onclick="loadTestData()">åŠ è½½æµ‹è¯•æ•°æ®</button>
                    <button class="btn btn-secondary" onclick="clearAllResults()">æ¸…ç©ºæ‰€æœ‰ç»“æœ</button>
                    <button class="btn btn-warning" onclick="testAllFunctions()">æµ‹è¯•æ‰€æœ‰åŠŸèƒ½</button>
                </div>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="test-section">
                <h2>ç»Ÿè®¡ä¿¡æ¯</h2>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number" id="commentCount">-</div>
                        <div class="stat-label">è¯„è®ºæ€»æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="likeCount">-</div>
                        <div class="stat-label">ç‚¹èµæ€»æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="userCount">-</div>
                        <div class="stat-label">æ´»è·ƒç”¨æˆ·</div>
                    </div>
                </div>
                <button class="btn" onclick="refreshStats()">åˆ·æ–°ç»Ÿè®¡</button>
            </div>

            <!-- æ·»åŠ è¯„è®º -->
            <div class="test-section">
                <h2>æ·»åŠ è¯„è®º</h2>
                <div class="form-group">
                    <label for="commentContent">è¯„è®ºå†…å®¹:</label>
                    <textarea id="commentContent" placeholder="è¯·è¾“å…¥è¯„è®ºå†…å®¹" oninput="previewComment()"></textarea>
                </div>
                <div class="comment-preview" id="commentPreview">
                    <strong>é¢„è§ˆ:</strong>
                    <div id="previewContent"></div>
                </div>
                <button class="btn" onclick="addComment()" id="addCommentBtn">æ·»åŠ è¯„è®º</button>
                <div id="addCommentResult" class="result-area" style="display: none;"></div>
            </div>

            <!-- æŸ¥çœ‹è¯„è®ºåˆ—è¡¨ -->
            <div class="test-section">
                <h2>æŸ¥çœ‹è¯„è®ºåˆ—è¡¨</h2>
                <div class="form-group">
                    <label for="pageNum">é¡µç :</label>
                    <input type="number" id="pageNum" value="1" min="1">
                </div>
                <div class="form-group">
                    <label for="pageSize">æ¯é¡µæ•°é‡:</label>
                    <input type="number" id="pageSize" value="10" min="1" max="50">
                </div>
                <button class="btn" onclick="getComments()">è·å–è¯„è®ºåˆ—è¡¨</button>
                <button class="btn btn-secondary" onclick="getCommentCount()">è·å–è¯„è®ºæ€»æ•°</button>
                <div id="commentsResult" class="result-area" style="display: none;"></div>
            </div>

            <!-- å›å¤è¯„è®º -->
            <div class="test-section">
                <h2>å›å¤è¯„è®º</h2>
                <div class="form-group">
                    <label for="replyCommentId">è¦å›å¤çš„è¯„è®ºID:</label>
                    <input type="number" id="replyCommentId" placeholder="è¯·è¾“å…¥è¯„è®ºID">
                </div>
                <div class="form-group">
                    <label for="replyToUserId">å›å¤ç›®æ ‡ç”¨æˆ·ID:</label>
                    <input type="number" id="replyToUserId" placeholder="è¯·è¾“å…¥ç”¨æˆ·ID">
                </div>
                <div class="form-group">
                    <label for="replyContent">å›å¤å†…å®¹:</label>
                    <textarea id="replyContent" placeholder="è¯·è¾“å…¥å›å¤å†…å®¹"></textarea>
                </div>
                <button class="btn" onclick="replyComment()">å›å¤è¯„è®º</button>
                <div id="replyResult" class="result-area" style="display: none;"></div>
            </div>

            <!-- ç‚¹èµåŠŸèƒ½ -->
            <div class="test-section">
                <h2>ç‚¹èµåŠŸèƒ½</h2>
                <div class="form-group">
                    <label for="likeCommentId">è¯„è®ºID:</label>
                    <input type="number" id="likeCommentId" placeholder="è¯·è¾“å…¥è¯„è®ºID">
                </div>
                <button class="btn btn-success" onclick="likeComment()">ç‚¹èµè¯„è®º</button>
                <button class="btn btn-danger" onclick="unlikeComment()">å–æ¶ˆç‚¹èµ</button>
                <button class="btn btn-secondary" onclick="checkLikeStatus()">æ£€æŸ¥ç‚¹èµçŠ¶æ€</button>
                <button class="btn btn-warning" onclick="getLikeCount()">è·å–ç‚¹èµæ•°</button>
                <div id="likeResult" class="result-area" style="display: none;"></div>
            </div>

            <!-- åˆ é™¤è¯„è®º -->
            <div class="test-section">
                <h2>åˆ é™¤è¯„è®º</h2>
                <div class="form-group">
                    <label for="deleteCommentId">è¦åˆ é™¤çš„è¯„è®ºID:</label>
                    <input type="number" id="deleteCommentId" placeholder="è¯·è¾“å…¥è¯„è®ºID">
                </div>
                <button class="btn btn-danger" onclick="deleteComment()">åˆ é™¤è¯„è®º</button>
                <div id="deleteResult" class="result-area" style="display: none;"></div>
            </div>

            <!-- è·å–è¯„è®ºè¯¦æƒ… -->
            <div class="test-section">
                <h2>è·å–è¯„è®ºè¯¦æƒ…</h2>
                <div class="form-group">
                    <label for="detailCommentId">è¯„è®ºID:</label>
                    <input type="number" id="detailCommentId" placeholder="è¯·è¾“å…¥è¯„è®ºID">
                </div>
                <button class="btn" onclick="getCommentDetail()">è·å–è¯¦æƒ…</button>
                <div id="detailResult" class="result-area" style="display: none;"></div>
            </div>

            <!-- è·å–å›å¤åˆ—è¡¨ -->
            <div class="test-section">
                <h2>è·å–å›å¤åˆ—è¡¨</h2>
                <div class="form-group">
                    <label for="repliesCommentId">è¯„è®ºID:</label>
                    <input type="number" id="repliesCommentId" placeholder="è¯·è¾“å…¥è¯„è®ºID">
                </div>
                <button class="btn" onclick="getReplies()">è·å–å›å¤</button>
                <div id="repliesResult" class="result-area" style="display: none;"></div>
            </div>

            <!-- ç”¨æˆ·è¯„è®ºåˆ—è¡¨ -->
            <div class="test-section">
                <h2>ç”¨æˆ·è¯„è®ºåˆ—è¡¨</h2>
                <div class="form-group">
                    <label for="userCommentsId">ç”¨æˆ·ID:</label>
                    <input type="number" id="userCommentsId" placeholder="è¯·è¾“å…¥ç”¨æˆ·ID">
                </div>
                <button class="btn" onclick="getUserComments()">è·å–ç”¨æˆ·è¯„è®º</button>
                <div id="userCommentsResult" class="result-area" style="display: none;"></div>
            </div>

            <!-- è½¯åˆ é™¤è¯´æ˜å’Œç®¡ç† -->
            <div class="test-section">
                <h2>è½¯åˆ é™¤æœºåˆ¶è¯´æ˜</h2>
                <div class="soft-delete-info">
                    <div class="info-card">
                        <h3>ğŸ’¡ ä¸ºä»€ä¹ˆåˆ é™¤åæ•°æ®åº“è¿˜æœ‰è®°å½•ï¼Ÿ</h3>
                        <p>æœ¬ç³»ç»Ÿé‡‡ç”¨<strong>è½¯åˆ é™¤ï¼ˆé€»è¾‘åˆ é™¤ï¼‰</strong>æœºåˆ¶ï¼Œè¿™æ˜¯ä¸€ç§å®‰å…¨çš„æœ€ä½³å®è·µï¼š</p>
                        <ul>
                            <li>âœ… åˆ é™¤çš„è¯„è®ºä¸ä¼šåœ¨é¡µé¢æ˜¾ç¤º</li>
                            <li>âœ… æ•°æ®åº“ä¿ç•™è®°å½•ï¼Œé˜²æ­¢è¯¯åˆ é™¤</li>
                            <li>âœ… æ”¯æŒæ•°æ®æ¢å¤å’Œå®¡è®¡è¿½è¸ª</li>
                            <li>âœ… ä¿æŒæ•°æ®å®Œæ•´æ€§å’Œå…³è”å…³ç³»</li>
                        </ul>
                    </div>
                    
                    <div class="status-legend">
                        <h4>è¯„è®ºçŠ¶æ€è¯´æ˜ï¼š</h4>
                        <div class="status-item">
                            <span class="status-badge normal">1</span>
                            <span>æ­£å¸¸è¯„è®ºï¼ˆé¡µé¢æ˜¾ç¤ºï¼‰</span>
                        </div>
                        <div class="status-item">
                            <span class="status-badge deleted">0</span>
                            <span>å·²åˆ é™¤è¯„è®ºï¼ˆä¸æ˜¾ç¤ºï¼‰</span>
                        </div>
                        <div class="status-item">
                            <span class="status-badge pending">2</span>
                            <span>å®¡æ ¸ä¸­è¯„è®ºï¼ˆä¸æ˜¾ç¤ºï¼‰</span>
                        </div>
                    </div>
                </div>

                <div class="management-tools">
                    <h4>ç®¡ç†å·¥å…·ï¼š</h4>
                    <button class="btn btn-secondary" onclick="showCommentStatistics()">æŸ¥çœ‹è¯„è®ºç»Ÿè®¡</button>
                    <button class="btn btn-warning" onclick="showDeletedComments()">æŸ¥çœ‹å·²åˆ é™¤è¯„è®º</button>
                    <button class="btn" onclick="openSqlHelp()">SQLæŸ¥è¯¢å¸®åŠ©</button>
                    <div id="managementResult" class="result-area" style="display: none;"></div>
                </div>
            </div>

            <!-- å®æ—¶è¯„è®ºåŒº -->
            <div class="test-section">
                <h2>å®æ—¶è¯„è®ºåŒº</h2>
                <div class="comment-section-header">
                    <div class="comment-section-info">
                        <span id="currentSongTitle">æ­Œæ›²ID: <span id="displaySongId">1</span></span>
                        <span class="comment-count">å…± <span id="displayCommentCount">0</span> æ¡è¯„è®º</span>
                    </div>
                    <button class="btn btn-secondary" onclick="refreshComments()">åˆ·æ–°è¯„è®º</button>
                    <button class="btn" onclick="toggleAutoRefresh()" id="autoRefreshBtn">å¼€å¯è‡ªåŠ¨åˆ·æ–°</button>
                </div>
                
                <!-- å¿«é€Ÿå‘è¡¨è¯„è®º -->
                <div class="quick-comment">
                    <div class="quick-comment-header">
                        <img src="https://via.placeholder.com/40x40" alt="å¤´åƒ" class="user-avatar">
                        <span class="user-name">ç”¨æˆ· <span id="quickUserId">1</span></span>
                    </div>
                    <textarea id="quickCommentContent" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." rows="3"></textarea>
                    <div class="quick-comment-actions">
                        <button class="btn btn-success" onclick="quickAddComment()">å‘è¡¨è¯„è®º</button>
                        <span class="char-count"><span id="charCount">0</span>/500</span>
                    </div>
                </div>

                <!-- è¯„è®ºåˆ—è¡¨ -->
                <div id="commentsList" class="comments-list">
                    <div class="loading-comments">
                        <div class="loading">åŠ è½½è¯„è®ºä¸­...</div>
                    </div>
                </div>
                
                <!-- åˆ†é¡µæ§åˆ¶ -->
                <div class="comment-pagination" id="commentPagination" style="display: none;">
                    <button class="btn btn-secondary" onclick="loadPreviousPage()" id="prevPageBtn">ä¸Šä¸€é¡µ</button>
                    <span class="page-info">ç¬¬ <span id="currentPage">1</span> é¡µï¼Œå…± <span id="totalPages">1</span> é¡µ</span>
                    <button class="btn btn-secondary" onclick="loadNextPage()" id="nextPageBtn">ä¸‹ä¸€é¡µ</button>
                </div>
            </div>
        </div>

        <div class="nav-links">
            <a href="/index.html">è¿”å›é¦–é¡µ</a>
            <a href="/song-test.html">æ­Œæ›²æµ‹è¯•</a>
            <a href="/upload.html">æ–‡ä»¶ä¸Šä¼ </a>
        </div>
    </div>

    <!-- è‡ªåŠ¨åˆ·æ–°æŒ‡ç¤ºå™¨ -->
    <div class="auto-refresh-indicator" id="autoRefreshIndicator">
        <span>ğŸ”„ è‡ªåŠ¨åˆ·æ–°ä¸­...</span>
    </div>

    <script>
        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, data, isSuccess = true) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            
            if (isSuccess) {
                element.innerHTML = `<div class="status success">è¯·æ±‚æˆåŠŸ</div><pre>${JSON.stringify(data, null, 2)}</pre>`;
            } else {
                element.innerHTML = `<div class="status error">è¯·æ±‚å¤±è´¥</div><pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
        }

        // è·å–åŸºç¡€å‚æ•°
        function getBaseParams() {
            return {
                songId: parseInt(document.getElementById('songId').value),
                userId: parseInt(document.getElementById('userId').value),
                currentUserId: parseInt(document.getElementById('currentUserId').value)
            };
        }

        // éªŒè¯ç”¨æˆ·
        async function validateUsers() {
            const params = getBaseParams();
            showLoading('userValidationResult');

            try {
                const promises = [
                    fetch(`/api/user/getUserAvatar?id=${params.userId}`),
                    fetch(`/api/user/getUserAvatar?id=${params.currentUserId}`)
                ];

                const results = await Promise.all(promises);
                const userData = await results[0].json();
                const currentUserData = await results[1].json();

                const validationResult = {
                    userId: params.userId,
                    currentUserId: params.currentUserId,
                    userValid: userData.code === 1,
                    currentUserValid: currentUserData.code === 1,
                    userInfo: userData.data,
                    currentUserInfo: currentUserData.data
                };

                showResult('userValidationResult', validationResult, true);
            } catch (error) {
                showResult('userValidationResult', { error: error.message }, false);
            }
        }

        // åŠ è½½æµ‹è¯•æ•°æ®
        function loadTestData() {
            document.getElementById('songId').value = '1';
            document.getElementById('userId').value = '1';
            document.getElementById('currentUserId').value = '1';
            document.getElementById('commentContent').value = 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•è¯„è®ºï¼';
            document.getElementById('replyContent').value = 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•å›å¤ï¼';
            alert('æµ‹è¯•æ•°æ®å·²åŠ è½½ï¼Œè¯·å¼€å§‹æµ‹è¯•ï¼');
        }

        // æ¸…ç©ºæ‰€æœ‰ç»“æœ
        function clearAllResults() {
            const resultAreas = document.querySelectorAll('.result-area');
            resultAreas.forEach(area => {
                area.style.display = 'none';
                area.innerHTML = '';
            });
        }

        // æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
        async function testAllFunctions() {
            clearAllResults();
            
            // è®¾ç½®æµ‹è¯•æ•°æ®
            loadTestData();
            
            // ä¾æ¬¡æµ‹è¯•å„ä¸ªåŠŸèƒ½
            await addComment();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await getComments();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await getCommentCount();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await refreshStats();
            
            alert('æ‰€æœ‰åŠŸèƒ½æµ‹è¯•å®Œæˆï¼è¯·æŸ¥çœ‹å„ä¸ªç»“æœåŒºåŸŸã€‚');
        }

        // åˆ·æ–°ç»Ÿè®¡ä¿¡æ¯
        async function refreshStats() {
            const params = getBaseParams();
            
            try {
                const [commentCountRes, likeCountRes] = await Promise.all([
                    fetch(`/api/comment/count?songId=${params.songId}`),
                    fetch(`/api/comment/like/count?commentId=1`)
                ]);
                
                const commentCountData = await commentCountRes.json();
                const likeCountData = await likeCountRes.json();
                
                document.getElementById('commentCount').textContent = commentCountData.data || 0;
                document.getElementById('likeCount').textContent = likeCountData.data || 0;
                document.getElementById('userCount').textContent = '3'; // æµ‹è¯•ç”¨æˆ·æ•°
            } catch (error) {
                console.error('åˆ·æ–°ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // é¢„è§ˆè¯„è®º
        function previewComment() {
            const content = document.getElementById('commentContent').value;
            const preview = document.getElementById('commentPreview');
            const previewContent = document.getElementById('previewContent');
            
            if (content.trim()) {
                previewContent.textContent = content;
                preview.classList.add('show');
            } else {
                preview.classList.remove('show');
            }
        }

        // æ·»åŠ è¯„è®º
        async function addComment() {
            const content = document.getElementById('commentContent').value;
            if (!content.trim()) {
                alert('è¯·è¾“å…¥è¯„è®ºå†…å®¹');
                return;
            }

            const params = getBaseParams();
            const data = {
                songId: params.songId,
                userId: params.userId,
                content: content
            };

            const btn = document.getElementById('addCommentBtn');
            btn.disabled = true;
            btn.textContent = 'æ·»åŠ ä¸­...';

            showLoading('addCommentResult');

            try {
                const response = await fetch('/api/comment/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                showResult('addCommentResult', result, result.code === 1);
                
                if (result.code === 1) {
                    // æ¸…ç©ºè¾“å…¥æ¡†
                    document.getElementById('commentContent').value = '';
                    document.getElementById('commentPreview').classList.remove('show');
                    // åˆ·æ–°ç»Ÿè®¡
                    refreshStats();
                }
            } catch (error) {
                showResult('addCommentResult', { error: error.message }, false);
            } finally {
                btn.disabled = false;
                btn.textContent = 'æ·»åŠ è¯„è®º';
            }
        }

        // è·å–è¯„è®ºåˆ—è¡¨
        async function getComments() {
            const params = getBaseParams();
            const pageNum = document.getElementById('pageNum').value;
            const pageSize = document.getElementById('pageSize').value;

            showLoading('commentsResult');

            try {
                const url = `/api/comment/song/page?songId=${params.songId}&currentUserId=${params.currentUserId}&pageNum=${pageNum}&pageSize=${pageSize}`;
                const response = await fetch(url);
                const result = await response.json();
                showResult('commentsResult', result, result.code === 1);
            } catch (error) {
                showResult('commentsResult', { error: error.message }, false);
            }
        }

        // è·å–è¯„è®ºæ€»æ•°
        async function getCommentCount() {
            const params = getBaseParams();

            showLoading('commentsResult');

            try {
                const url = `/api/comment/count?songId=${params.songId}`;
                const response = await fetch(url);
                const result = await response.json();
                showResult('commentsResult', result, result.code === 1);
            } catch (error) {
                showResult('commentsResult', { error: error.message }, false);
            }
        }

        // å›å¤è¯„è®º
        async function replyComment() {
            const commentId = document.getElementById('replyCommentId').value;
            const replyToUserId = document.getElementById('replyToUserId').value;
            const content = document.getElementById('replyContent').value;

            if (!commentId || !content.trim()) {
                alert('è¯·è¾“å…¥è¯„è®ºIDå’Œå›å¤å†…å®¹');
                return;
            }

            const params = getBaseParams();
            const data = {
                commentId: parseInt(commentId),
                userId: params.userId,
                replyToUserId: parseInt(replyToUserId),
                content: content
            };

            showLoading('replyResult');

            try {
                const response = await fetch('/api/comment/reply', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                showResult('replyResult', result, result.code === 1);
                
                if (result.code === 1) {
                    // æ¸…ç©ºè¾“å…¥æ¡†
                    document.getElementById('replyContent').value = '';
                }
            } catch (error) {
                showResult('replyResult', { error: error.message }, false);
            }
        }

        // ç‚¹èµè¯„è®º
        async function likeComment() {
            const commentId = document.getElementById('likeCommentId').value;
            if (!commentId) {
                alert('è¯·è¾“å…¥è¯„è®ºID');
                return;
            }

            const params = getBaseParams();
            const data = {
                commentId: parseInt(commentId),
                userId: params.userId
            };

            showLoading('likeResult');

            try {
                const response = await fetch('/api/comment/like', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                showResult('likeResult', result, result.code === 1);
            } catch (error) {
                showResult('likeResult', { error: error.message }, false);
            }
        }

        // å–æ¶ˆç‚¹èµ
        async function unlikeComment() {
            const commentId = document.getElementById('likeCommentId').value;
            if (!commentId) {
                alert('è¯·è¾“å…¥è¯„è®ºID');
                return;
            }

            const params = getBaseParams();
            const data = {
                commentId: parseInt(commentId),
                userId: params.userId
            };

            showLoading('likeResult');

            try {
                const response = await fetch('/api/comment/unlike', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                showResult('likeResult', result, result.code === 1);
            } catch (error) {
                showResult('likeResult', { error: error.message }, false);
            }
        }

        // æ£€æŸ¥ç‚¹èµçŠ¶æ€
        async function checkLikeStatus() {
            const commentId = document.getElementById('likeCommentId').value;
            if (!commentId) {
                alert('è¯·è¾“å…¥è¯„è®ºID');
                return;
            }

            const params = getBaseParams();

            showLoading('likeResult');

            try {
                const url = `/api/comment/like/check?commentId=${commentId}&userId=${params.userId}`;
                const response = await fetch(url);
                const result = await response.json();
                showResult('likeResult', result, result.code === 1);
            } catch (error) {
                showResult('likeResult', { error: error.message }, false);
            }
        }

        // è·å–ç‚¹èµæ•°
        async function getLikeCount() {
            const commentId = document.getElementById('likeCommentId').value;
            if (!commentId) {
                alert('è¯·è¾“å…¥è¯„è®ºID');
                return;
            }

            showLoading('likeResult');

            try {
                const url = `/api/comment/like/count?commentId=${commentId}`;
                const response = await fetch(url);
                const result = await response.json();
                showResult('likeResult', result, result.code === 1);
            } catch (error) {
                showResult('likeResult', { error: error.message }, false);
            }
        }

        // åˆ é™¤è¯„è®º
        async function deleteComment() {
            const commentId = document.getElementById('deleteCommentId').value;
            if (!commentId) {
                alert('è¯·è¾“å…¥è¯„è®ºID');
                return;
            }

            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                return;
            }

            const params = getBaseParams();

            showLoading('deleteResult');

            try {
                const response = await fetch('/api/comment/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `commentId=${commentId}&userId=${params.userId}`
                });

                const result = await response.json();
                showResult('deleteResult', result, result.code === 1);
            } catch (error) {
                showResult('deleteResult', { error: error.message }, false);
            }
        }

        // è·å–è¯„è®ºè¯¦æƒ…
        async function getCommentDetail() {
            const commentId = document.getElementById('detailCommentId').value;
            if (!commentId) {
                alert('è¯·è¾“å…¥è¯„è®ºID');
                return;
            }

            const params = getBaseParams();

            showLoading('detailResult');

            try {
                const url = `/api/comment/detail?commentId=${commentId}&currentUserId=${params.currentUserId}`;
                const response = await fetch(url);
                const result = await response.json();
                showResult('detailResult', result, result.code === 1);
            } catch (error) {
                showResult('detailResult', { error: error.message }, false);
            }
        }

        // è·å–å›å¤åˆ—è¡¨
        async function getReplies() {
            const commentId = document.getElementById('repliesCommentId').value;
            if (!commentId) {
                alert('è¯·è¾“å…¥è¯„è®ºID');
                return;
            }

            const params = getBaseParams();

            showLoading('repliesResult');

            try {
                const url = `/api/comment/replies?commentId=${commentId}&currentUserId=${params.currentUserId}`;
                const response = await fetch(url);
                const result = await response.json();
                showResult('repliesResult', result, result.code === 1);
            } catch (error) {
                showResult('repliesResult', { error: error.message }, false);
            }
        }

        // è·å–ç”¨æˆ·è¯„è®ºåˆ—è¡¨
        async function getUserComments() {
            const userId = document.getElementById('userCommentsId').value;
            if (!userId) {
                alert('è¯·è¾“å…¥ç”¨æˆ·ID');
                return;
            }

            const params = getBaseParams();

            showLoading('userCommentsResult');

            try {
                const url = `/api/comment/user?userId=${userId}&currentUserId=${params.currentUserId}`;
                const response = await fetch(url);
                const result = await response.json();
                showResult('userCommentsResult', result, result.code === 1);
            } catch (error) {
                showResult('userCommentsResult', { error: error.message }, false);
            }
        }

        // è¯„è®ºåŒºç›¸å…³å˜é‡
        let currentCommentPage = 1;
        let commentPageSize = 10;
        let totalCommentPages = 1;
        let autoRefreshInterval = null;
        let isAutoRefresh = false;

        // åˆå§‹åŒ–è¯„è®ºåŒº
        function initializeCommentsSection() {
            updateDisplayValues();
            loadCommentsPage(1);
            
            // ç»‘å®šå¿«é€Ÿè¯„è®ºè¾“å…¥æ¡†äº‹ä»¶
            const quickCommentInput = document.getElementById('quickCommentContent');
            quickCommentInput.addEventListener('input', function() {
                const charCount = this.value.length;
                document.getElementById('charCount').textContent = charCount;
                
                if (charCount > 500) {
                    this.value = this.value.substring(0, 500);
                    document.getElementById('charCount').textContent = 500;
                }
            });
        }

        // æ›´æ–°æ˜¾ç¤ºçš„å€¼
        function updateDisplayValues() {
            const params = getBaseParams();
            document.getElementById('displaySongId').textContent = params.songId;
            document.getElementById('quickUserId').textContent = params.userId;
        }

        // å¿«é€Ÿå‘è¡¨è¯„è®º
        async function quickAddComment() {
            const content = document.getElementById('quickCommentContent').value.trim();
            if (!content) {
                alert('è¯·è¾“å…¥è¯„è®ºå†…å®¹');
                return;
            }

            const params = getBaseParams();
            const data = {
                songId: params.songId,
                userId: params.userId,
                content: content
            };

            try {
                const response = await fetch('/api/comment/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.code === 1) {
                    document.getElementById('quickCommentContent').value = '';
                    document.getElementById('charCount').textContent = '0';
                    
                    // åˆ·æ–°è¯„è®ºåˆ—è¡¨
                    await loadCommentsPage(1);
                    await refreshStats();
                    
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    showToast('è¯„è®ºå‘è¡¨æˆåŠŸï¼', 'success');
                } else {
                    showToast('å‘è¡¨å¤±è´¥ï¼š' + result.message, 'error');
                }
            } catch (error) {
                console.error('å‘è¡¨è¯„è®ºå¤±è´¥:', error);
                showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // åŠ è½½è¯„è®ºé¡µé¢
        async function loadCommentsPage(page) {
            currentCommentPage = page;
            const params = getBaseParams();
            
            try {
                showCommentsLoading();
                
                const response = await fetch(`/api/comment/song/page?songId=${params.songId}&currentUserId=${params.currentUserId}&pageNum=${page}&pageSize=${commentPageSize}`);
                const result = await response.json();
                
                if (result.code === 1) {
                    displayComments(result.data);
                    updateCommentPagination(result.data);
                    updateCommentCount(result.data.total);
                } else {
                    showCommentsError('åŠ è½½è¯„è®ºå¤±è´¥ï¼š' + result.message);
                }
            } catch (error) {
                console.error('åŠ è½½è¯„è®ºå¤±è´¥:', error);
                showCommentsError('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        // æ˜¾ç¤ºè¯„è®ºåˆ—è¡¨
        function displayComments(pageData) {
            const commentsList = document.getElementById('commentsList');
            
            if (!pageData.data || pageData.data.length === 0) {
                commentsList.innerHTML = `
                    <div class="no-comments">
                        <div style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;">ğŸ’¬</div>
                        <div>æš‚æ— è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            pageData.data.forEach(comment => {
                html += generateCommentHTML(comment);
            });
            
            commentsList.innerHTML = html;
        }

        // ç”Ÿæˆè¯„è®ºHTML
        function generateCommentHTML(comment) {
            const timeAgo = formatTimeAgo(comment.createTime);
            const avatarUrl = comment.userAvatar || 'https://via.placeholder.com/40x40';
            
            let repliesHTML = '';
            if (comment.replyCount > 0) {
                repliesHTML = `
                    <div class="show-replies-btn" onclick="toggleReplies(${comment.id})">
                        <span id="repliesText_${comment.id}">æŸ¥çœ‹ ${comment.replyCount} æ¡å›å¤</span>
                    </div>
                    <div id="replies_${comment.id}" class="replies-section" style="display: none;">
                        <div class="loading">åŠ è½½å›å¤ä¸­...</div>
                    </div>
                `;
            }
            
            return `
                <div class="comment-item" data-comment-id="${comment.id}">
                    <div class="comment-main">
                        <img src="${avatarUrl}" alt="å¤´åƒ" class="comment-avatar">
                        <div class="comment-body">
                            <div class="comment-meta">
                                <span class="comment-author">${comment.userNickname || 'ç”¨æˆ·' + comment.userId}</span>
                                <span class="comment-time">${timeAgo}</span>
                            </div>
                            <div class="comment-content">${escapeHtml(comment.content)}</div>
                            <div class="comment-actions">
                                <div class="comment-action ${comment.isLiked ? 'liked' : ''}" onclick="toggleLike(${comment.id}, ${comment.userId})">
                                    <span>${comment.isLiked ? 'â¤ï¸' : 'ğŸ¤'}</span>
                                    <span id="likeCount_${comment.id}">${comment.likeCount}</span>
                                </div>
                                <div class="comment-action" onclick="showReplyForm(${comment.id}, '${comment.userNickname || 'ç”¨æˆ·' + comment.userId}')">
                                    <span>ğŸ’¬</span>
                                    <span>å›å¤</span>
                                </div>
                                ${comment.userId === getBaseParams().currentUserId ? `
                                    <div class="comment-action" onclick="deleteCommentConfirm(${comment.id})">
                                        <span>ğŸ—‘ï¸</span>
                                        <span>åˆ é™¤</span>
                                    </div>
                                ` : ''}
                            </div>
                            ${repliesHTML}
                        </div>
                    </div>
                </div>
            `;
        }

        // ç”Ÿæˆå›å¤HTML
        function generateReplyHTML(reply) {
            const timeAgo = formatTimeAgo(reply.createTime);
            const replyTarget = reply.replyToUserNickname ? `å›å¤ @${reply.replyToUserNickname}` : '';
            
            return `
                <div class="reply-item" data-reply-id="${reply.id}">
                    <div class="reply-meta">
                        <span class="reply-author">${reply.userNickname || 'ç”¨æˆ·' + reply.userId}</span>
                        ${replyTarget ? `<span class="reply-target">${replyTarget}</span>` : ''}
                        <span class="comment-time">${timeAgo}</span>
                    </div>
                    <div class="reply-content">${escapeHtml(reply.content)}</div>
                    <div class="reply-actions">
                        <div class="comment-action ${reply.isLiked ? 'liked' : ''}" onclick="toggleLike(${reply.id}, ${reply.userId})">
                            <span>${reply.isLiked ? 'â¤ï¸' : 'ğŸ¤'}</span>
                            <span id="likeCount_${reply.id}">${reply.likeCount}</span>
                        </div>
                        <div class="comment-action" onclick="showReplyForm(${reply.id}, '${reply.userNickname || 'ç”¨æˆ·' + reply.userId}')">
                            <span>ğŸ’¬</span>
                            <span>å›å¤</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // åˆ‡æ¢å›å¤æ˜¾ç¤º
        async function toggleReplies(commentId) {
            const repliesDiv = document.getElementById(`replies_${commentId}`);
            const repliesText = document.getElementById(`repliesText_${commentId}`);
            
            if (repliesDiv.style.display === 'none') {
                // æ˜¾ç¤ºå›å¤
                repliesDiv.style.display = 'block';
                repliesText.textContent = 'æ”¶èµ·å›å¤';
                
                // åŠ è½½å›å¤
                try {
                    const params = getBaseParams();
                    const response = await fetch(`/api/comment/replies?commentId=${commentId}&currentUserId=${params.currentUserId}`);
                    const result = await response.json();
                    
                    if (result.code === 1 && result.data) {
                        let repliesHTML = '';
                        result.data.forEach(reply => {
                            repliesHTML += generateReplyHTML(reply);
                        });
                        repliesDiv.innerHTML = repliesHTML;
                    } else {
                        repliesDiv.innerHTML = '<div class="no-comments">æš‚æ— å›å¤</div>';
                    }
                } catch (error) {
                    console.error('åŠ è½½å›å¤å¤±è´¥:', error);
                    repliesDiv.innerHTML = '<div class="no-comments">åŠ è½½å›å¤å¤±è´¥</div>';
                }
            } else {
                // éšè—å›å¤
                repliesDiv.style.display = 'none';
                repliesText.textContent = `æŸ¥çœ‹å›å¤`;
            }
        }

        // åˆ‡æ¢ç‚¹èµ
        async function toggleLike(commentId, authorUserId) {
            const params = getBaseParams();
            const likeCountSpan = document.getElementById(`likeCount_${commentId}`);
            const currentCount = parseInt(likeCountSpan.textContent);
            
            try {
                // å…ˆæ£€æŸ¥ç‚¹èµçŠ¶æ€
                const checkResponse = await fetch(`/api/comment/like/check?commentId=${commentId}&userId=${params.userId}`);
                const checkResult = await checkResponse.json();
                
                if (checkResult.code === 1) {
                    const isLiked = checkResult.data;
                    const url = isLiked ? '/api/comment/unlike' : '/api/comment/like';
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            commentId: commentId,
                            userId: params.userId
                        })
                    });
                    
                    const result = await response.json();
                    if (result.code === 1) {
                        // æ›´æ–°UI
                        const actionElement = likeCountSpan.parentElement;
                        if (isLiked) {
                            actionElement.classList.remove('liked');
                            actionElement.querySelector('span:first-child').textContent = 'ğŸ¤';
                            likeCountSpan.textContent = Math.max(0, currentCount - 1);
                        } else {
                            actionElement.classList.add('liked');
                            actionElement.querySelector('span:first-child').textContent = 'â¤ï¸';
                            likeCountSpan.textContent = currentCount + 1;
                        }
                    }
                }
            } catch (error) {
                console.error('ç‚¹èµæ“ä½œå¤±è´¥:', error);
                showToast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // æ˜¾ç¤ºå›å¤è¡¨å•
        function showReplyForm(commentId, authorName) {
            const replyContent = prompt(`å›å¤ @${authorName}:`);
            if (replyContent && replyContent.trim()) {
                submitReply(commentId, replyContent.trim());
            }
        }

        // æäº¤å›å¤
        async function submitReply(commentId, content) {
            const params = getBaseParams();
            
            try {
                const response = await fetch('/api/comment/reply', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        commentId: commentId,
                        userId: params.userId,
                        replyToUserId: 0, // æš‚æ—¶è®¾ä¸º0ï¼Œå¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹
                        content: content
                    })
                });
                
                const result = await response.json();
                if (result.code === 1) {
                    showToast('å›å¤æˆåŠŸï¼', 'success');
                    // é‡æ–°åŠ è½½å½“å‰é¡µé¢
                    await loadCommentsPage(currentCommentPage);
                } else {
                    showToast('å›å¤å¤±è´¥ï¼š' + result.message, 'error');
                }
            } catch (error) {
                console.error('æäº¤å›å¤å¤±è´¥:', error);
                showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // åˆ é™¤è¯„è®ºç¡®è®¤
        function deleteCommentConfirm(commentId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                deleteCommentById(commentId);
            }
        }

        // åˆ é™¤è¯„è®º
        async function deleteCommentById(commentId) {
            const params = getBaseParams();
            
            try {
                const response = await fetch('/api/comment/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `commentId=${commentId}&userId=${params.userId}`
                });
                
                const result = await response.json();
                if (result.code === 1) {
                    showToast('åˆ é™¤æˆåŠŸï¼', 'success');
                    // é‡æ–°åŠ è½½å½“å‰é¡µé¢
                    await loadCommentsPage(currentCommentPage);
                    await refreshStats();
                } else {
                    showToast('åˆ é™¤å¤±è´¥ï¼š' + result.message, 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤è¯„è®ºå¤±è´¥:', error);
                showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // åˆ·æ–°è¯„è®º
        async function refreshComments() {
            updateDisplayValues();
            await loadCommentsPage(currentCommentPage);
            await refreshStats();
            showToast('è¯„è®ºå·²åˆ·æ–°', 'info');
        }

        // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°
        function toggleAutoRefresh() {
            const btn = document.getElementById('autoRefreshBtn');
            const indicator = document.getElementById('autoRefreshIndicator');
            
            if (isAutoRefresh) {
                // å…³é—­è‡ªåŠ¨åˆ·æ–°
                clearInterval(autoRefreshInterval);
                isAutoRefresh = false;
                btn.textContent = 'å¼€å¯è‡ªåŠ¨åˆ·æ–°';
                btn.classList.remove('btn-danger');
                indicator.classList.remove('show');
            } else {
                // å¼€å¯è‡ªåŠ¨åˆ·æ–°
                autoRefreshInterval = setInterval(async () => {
                    await loadCommentsPage(currentCommentPage);
                    await refreshStats();
                }, 10000); // æ¯10ç§’åˆ·æ–°ä¸€æ¬¡
                
                isAutoRefresh = true;
                btn.textContent = 'å…³é—­è‡ªåŠ¨åˆ·æ–°';
                btn.classList.add('btn-danger');
                indicator.classList.add('show');
                showToast('å·²å¼€å¯è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯10ç§’ï¼‰', 'success');
            }
        }

        // ä¸Šä¸€é¡µ
        function loadPreviousPage() {
            if (currentCommentPage > 1) {
                loadCommentsPage(currentCommentPage - 1);
            }
        }

        // ä¸‹ä¸€é¡µ
        function loadNextPage() {
            if (currentCommentPage < totalCommentPages) {
                loadCommentsPage(currentCommentPage + 1);
            }
        }

        // æ›´æ–°åˆ†é¡µä¿¡æ¯
        function updateCommentPagination(pageData) {
            const pagination = document.getElementById('commentPagination');
            const currentPageSpan = document.getElementById('currentPage');
            const totalPagesSpan = document.getElementById('totalPages');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            
            totalCommentPages = pageData.totalPages || 1;
            
            currentPageSpan.textContent = currentCommentPage;
            totalPagesSpan.textContent = totalCommentPages;
            
            prevBtn.disabled = currentCommentPage <= 1;
            nextBtn.disabled = currentCommentPage >= totalCommentPages;
            
            pagination.style.display = totalCommentPages > 1 ? 'flex' : 'none';
        }

        // æ›´æ–°è¯„è®ºæ•°é‡
        function updateCommentCount(total) {
            document.getElementById('displayCommentCount').textContent = total || 0;
        }

        // æ˜¾ç¤ºè¯„è®ºåŠ è½½çŠ¶æ€
        function showCommentsLoading() {
            document.getElementById('commentsList').innerHTML = `
                <div class="loading-comments">
                    <div class="loading">åŠ è½½è¯„è®ºä¸­...</div>
                </div>
            `;
        }

        // æ˜¾ç¤ºè¯„è®ºé”™è¯¯
        function showCommentsError(message) {
            document.getElementById('commentsList').innerHTML = `
                <div class="no-comments">
                    <div style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;">âš ï¸</div>
                    <div>${message}</div>
                </div>
            `;
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTimeAgo(dateString) {
            if (!dateString) return 'åˆšåˆš';
            
            const date = new Date(dateString);
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'åˆšåˆš';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}åˆ†é’Ÿå‰`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}å°æ—¶å‰`;
            if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)}å¤©å‰`;
            
            return date.toLocaleDateString();
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'info') {
            // åˆ›å»ºæç¤ºå…ƒç´ 
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
                color: white;
                padding: 12px 20px;
                border-radius: 5px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                z-index: 1001;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => toast.style.opacity = '1', 100);
            
            // è‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // è½¯åˆ é™¤ç®¡ç†åŠŸèƒ½
        function showCommentStatistics() {
            const statisticsData = {
                title: "è¯„è®ºç»Ÿè®¡ä¿¡æ¯",
                description: "ä»¥ä¸‹SQLå¯ä»¥å¸®åŠ©æ‚¨äº†è§£è¯„è®ºçš„çŠ¶æ€åˆ†å¸ƒ",
                queries: [
                    {
                        name: "è¯„è®ºçŠ¶æ€ç»Ÿè®¡",
                        sql: `SELECT 
    status,
    CASE 
        WHEN status = 0 THEN 'å·²åˆ é™¤'
        WHEN status = 1 THEN 'æ­£å¸¸'
        WHEN status = 2 THEN 'å®¡æ ¸ä¸­'
        ELSE 'æœªçŸ¥'
    END as status_name,
    COUNT(*) as count
FROM tb_comment 
GROUP BY status;`
                    },
                    {
                        name: "åˆ é™¤ç‡ç»Ÿè®¡",
                        sql: `SELECT 
    COUNT(CASE WHEN status = 1 THEN 1 END) as active_comments,
    COUNT(CASE WHEN status = 0 THEN 1 END) as deleted_comments,
    ROUND(COUNT(CASE WHEN status = 0 THEN 1 END) * 100.0 / COUNT(*), 2) as deletion_rate
FROM tb_comment;`
                    }
                ]
            };
            
            showResult('managementResult', statisticsData, true);
        }

        function showDeletedComments() {
            const deletedCommentsData = {
                title: "æŸ¥çœ‹å·²åˆ é™¤è¯„è®º",
                description: "ä½¿ç”¨ä»¥ä¸‹SQLæŸ¥è¯¢å·²åˆ é™¤çš„è¯„è®ºè®°å½•",
                queries: [
                    {
                        name: "æŸ¥çœ‹æ‰€æœ‰å·²åˆ é™¤è¯„è®º",
                        sql: `SELECT 
    c.id, 
    c.user_id, 
    u.nickname as user_nickname,
    c.content, 
    c.create_time, 
    c.update_time as delete_time
FROM tb_comment c
LEFT JOIN tb_user u ON c.user_id = u.id
WHERE c.status = 0 
ORDER BY c.update_time DESC;`
                    },
                    {
                        name: "æŸ¥çœ‹ç‰¹å®šæ­Œæ›²çš„å·²åˆ é™¤è¯„è®º",
                        sql: `SELECT 
    c.id, 
    c.user_id, 
    u.nickname as user_nickname,
    c.content, 
    c.create_time, 
    c.update_time as delete_time
FROM tb_comment c
LEFT JOIN tb_user u ON c.user_id = u.id
WHERE c.status = 0 AND c.song_id = 1
ORDER BY c.update_time DESC;`
                    },
                    {
                        name: "æ¢å¤ç‰¹å®šè¯„è®ºï¼ˆè°¨æ…ä½¿ç”¨ï¼‰",
                        sql: `-- æ¢å¤IDä¸º1çš„è¯„è®º
UPDATE tb_comment 
SET status = 1, update_time = NOW() 
WHERE id = 1 AND status = 0;`
                    }
                ]
            };
            
            showResult('managementResult', deletedCommentsData, true);
        }

        function openSqlHelp() {
            const sqlHelpData = {
                title: "SQLæŸ¥è¯¢å¸®åŠ©",
                description: "å¸¸ç”¨çš„è¯„è®ºç®¡ç†SQLè¯­å¥",
                queries: [
                    {
                        name: "æŸ¥çœ‹æ‰€æœ‰è¯„è®ºï¼ˆåŒ…æ‹¬å·²åˆ é™¤ï¼‰",
                        sql: `SELECT 
    id, user_id, content, status, 
    create_time, update_time 
FROM tb_comment 
ORDER BY create_time DESC;`
                    },
                    {
                        name: "æŸ¥çœ‹æ­£å¸¸è¯„è®ºï¼ˆé¡µé¢æ˜¾ç¤ºçš„ï¼‰",
                        sql: `SELECT 
    id, user_id, content, status, 
    create_time, update_time 
FROM tb_comment 
WHERE status = 1 
ORDER BY create_time DESC;`
                    },
                    {
                        name: "ç‰©ç†åˆ é™¤å·²æ ‡è®°åˆ é™¤çš„è¯„è®ºï¼ˆå±é™©æ“ä½œï¼‰",
                        sql: `-- åˆ é™¤è¶…è¿‡30å¤©çš„å·²åˆ é™¤è¯„è®º
DELETE FROM tb_comment 
WHERE status = 0 
AND update_time < DATE_SUB(NOW(), INTERVAL 30 DAY);`
                    },
                    {
                        name: "æ‰¹é‡æ¢å¤æŸç”¨æˆ·çš„è¯„è®º",
                        sql: `-- æ¢å¤ç”¨æˆ·IDä¸º1çš„æ‰€æœ‰å·²åˆ é™¤è¯„è®º
UPDATE tb_comment 
SET status = 1, update_time = NOW() 
WHERE user_id = 1 AND status = 0;`
                    },
                    {
                        name: "æŸ¥çœ‹è¯„è®ºä¸ç”¨æˆ·ä¿¡æ¯å…³è”",
                        sql: `SELECT 
    c.id, 
    c.content, 
    c.status,
    u.nickname as user_name,
    c.create_time,
    CASE 
        WHEN c.status = 0 THEN 'å·²åˆ é™¤'
        WHEN c.status = 1 THEN 'æ­£å¸¸'
        WHEN c.status = 2 THEN 'å®¡æ ¸ä¸­'
    END as status_text
FROM tb_comment c
LEFT JOIN tb_user u ON c.user_id = u.id
ORDER BY c.create_time DESC;`
                    }
                ],
                tips: [
                    "ğŸ’¡ å»ºè®®å…ˆåœ¨æµ‹è¯•ç¯å¢ƒè¿è¡Œè¿™äº›SQL",
                    "âš ï¸ ç‰©ç†åˆ é™¤æ“ä½œä¸å¯æ¢å¤ï¼Œè¯·è°¨æ…ä½¿ç”¨",
                    "ğŸ” ä½¿ç”¨WHEREæ¡ä»¶é™åˆ¶æ“ä½œèŒƒå›´",
                    "ğŸ“Š å®šæœŸæ£€æŸ¥åˆ é™¤ç‡ï¼Œäº†è§£ç”¨æˆ·è¡Œä¸º"
                ]
            };
            
            showResult('managementResult', sqlHelpData, true);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            refreshStats();
            initializeCommentsSection();
        });
    </script>
</body>
</html> 