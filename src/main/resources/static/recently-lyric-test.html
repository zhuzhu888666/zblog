<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>最近播放 & 歌词 功能测试</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif; margin: 24px; color: #222; }
    h2 { margin-top: 32px; }
    fieldset { border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin-bottom: 24px; }
    legend { padding: 0 8px; color: #666; }
    label { margin-right: 8px; }
    input[type="text"], input[type="number"] { padding: 6px 10px; border: 1px solid #ccc; border-radius: 6px; }
    button { padding: 6px 12px; border: 1px solid #0d6efd; background: #0d6efd; color: #fff; border-radius: 6px; cursor: pointer; margin-right: 8px; }
    button.flat { background: #fff; color: #0d6efd; }
    .row { display: flex; align-items: center; gap: 10px; margin: 8px 0; flex-wrap: wrap; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 12px; }
    .card { border: 1px solid #eee; border-radius: 8px; padding: 12px; }
    .cover { width: 100%; height: 160px; object-fit: cover; border-radius: 6px; background: #fafafa; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; white-space: pre-wrap; word-break: break-all; }
    .muted { color: #777; }
  </style>
  <script>
    async function fetchJSON(url, options) {
      const res = await fetch(url, options);
      const text = await res.text();
      try { return JSON.parse(text); } catch { return { raw: text }; }
    }

    // ============ 最近播放 ============
    async function queryRecentlyPlayed() {
      const userId = document.getElementById('rp-userId').value.trim();
      if (!userId) { alert('请输入用户ID'); return; }
      const data = await fetchJSON(`/user/recently-played/getRecentlyPlayed?userId=${encodeURIComponent(userId)}`);
      renderRecentlyPlayed(data);
    }

    async function addRecentlyPlayed() {
      const userId = document.getElementById('rp-userId').value.trim();
      const songId = document.getElementById('rp-songId').value.trim();
      if (!userId || !songId) { alert('请输入用户ID与歌曲ID'); return; }
      const data = await fetchJSON('/user/recently-played/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId: Number(userId), songId: Number(songId) })
      });
      document.getElementById('rp-result').textContent = JSON.stringify(data, null, 2);
    }

    function renderRecentlyPlayed(resp) {
      const container = document.getElementById('rp-list');
      container.innerHTML = '';
      document.getElementById('rp-result').textContent = JSON.stringify(resp, null, 2);
      if (!resp || !resp.data || !Array.isArray(resp.data)) return;
      for (const s of resp.data) {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <img class="cover" src="${s.coverPath || ''}" alt="cover" />
          <div class="row"><strong>${s.name || ''}</strong><span class="muted">#${s.id}</span></div>
          <div class="muted">${s.artistName || ''}</div>
          <div class="muted">${s.album || ''}</div>
        `;
        container.appendChild(card);
      }
    }

    // ============ 歌词 ============
    async function getLyric() {
      const songId = document.getElementById('ly-songId').value.trim();
      if (!songId) { alert('请输入歌曲ID'); return; }
      const data = await fetchJSON(`/lrc/getLrc?id=${encodeURIComponent(songId)}`);
      document.getElementById('ly-result').textContent = JSON.stringify(data, null, 2);
      const url = data && data.data ? data.data : '';
      const link = document.getElementById('ly-url');
      if (url) {
        link.href = url; link.textContent = '打开歌词URL'; link.style.display = 'inline-block';
      } else {
        link.removeAttribute('href'); link.textContent = ''; link.style.display = 'none';
      }
    }

    async function uploadLyric() {
      const songId = document.getElementById('ly-songId').value.trim();
      const fileInput = document.getElementById('ly-file');
      if (!songId || !fileInput.files.length) { alert('请输入歌曲ID并选择文件'); return; }
      const fd = new FormData();
      fd.append('id', songId);
      fd.append('lrcFile', fileInput.files[0]);
      const data = await fetchJSON('/lrc/upload', { method: 'POST', body: fd });
      document.getElementById('ly-result').textContent = JSON.stringify(data, null, 2);
    }

    async function updateLyric() {
      const songId = document.getElementById('ly-songId').value.trim();
      const fileInput = document.getElementById('ly-file');
      if (!songId || !fileInput.files.length) { alert('请输入歌曲ID并选择文件'); return; }
      const fd = new FormData();
      fd.append('id', songId);
      fd.append('file', fileInput.files[0]);
      const data = await fetchJSON('/lrc/update', { method: 'POST', body: fd });
      document.getElementById('ly-result').textContent = JSON.stringify(data, null, 2);
    }

    async function deleteLyric() {
      const songId = document.getElementById('ly-songId').value.trim();
      if (!songId) { alert('请输入歌曲ID'); return; }
      const data = await fetchJSON(`/lrc/delete?id=${encodeURIComponent(songId)}`, { method: 'POST' });
      document.getElementById('ly-result').textContent = JSON.stringify(data, null, 2);
    }
  </script>
</head>
<body>
  <h1>最近播放 & 歌词 功能测试</h1>

  <fieldset>
    <legend>最近播放</legend>
    <div class="row">
      <label for="rp-userId">用户ID</label>
      <input id="rp-userId" type="number" placeholder="例如：1" />
      <button onclick="queryRecentlyPlayed()">查询最近播放</button>
    </div>
    <div class="row">
      <label for="rp-songId">歌曲ID</label>
      <input id="rp-songId" type="number" placeholder="例如：1001" />
      <button class="flat" onclick="addRecentlyPlayed()">添加最近播放</button>
    </div>
    <div class="grid" id="rp-list"></div>
    <div>
      <div class="muted">响应</div>
      <pre class="mono" id="rp-result"></pre>
    </div>
  </fieldset>

  <fieldset>
    <legend>歌曲歌词</legend>
    <div class="row">
      <label for="ly-songId">歌曲ID</label>
      <input id="ly-songId" type="number" placeholder="例如：1001" />
      <button onclick="getLyric()">获取歌词URL</button>
      <a id="ly-url" href="#" target="_blank" style="display:none; margin-left:8px;">打开歌词URL</a>
    </div>
    <div class="row">
      <input id="ly-file" type="file" accept=".lrc,.txt" />
      <button class="flat" onclick="uploadLyric()">上传歌词</button>
      <button class="flat" onclick="updateLyric()">更新歌词</button>
      <button style="background:#dc3545;border-color:#dc3545" onclick="deleteLyric()">删除歌词</button>
    </div>
    <div>
      <div class="muted">响应</div>
      <pre class="mono" id="ly-result"></pre>
    </div>
  </fieldset>

  <p class="muted">提示：该页面直接调用后端接口，请先启动后端应用。</p>
</body>
</html>


